import{r as p,v as ae,av as _e,e as ze,au as Fe,g as Ve,q as $e,dx as Re,a as S,j as i,_ as r,B as R,t as ke,i as Ae,S as je,ae as Se,cQ as Le,aY as Ke,c as Ne,F as Ie,y as Ee,dy as Me,dz as Qe,dA as He,l as de,dc as We,cj as Ye,aT as ue,aB as Be,n as Xe,L as Je,x as pe,p as Ze}from"./main-moody-dragons-sleep.js";import{b as Ge,a3 as et,D as Z,m as tt}from"./_applist-880.js";import{S as X}from"./index-295.js";import{c as G,a as at,b as me}from"./mutative-278.js";import{l as ye}from"./lodash-939.js";import{I as K}from"./index-973.js";import{T as H,R as st}from"./index-133.js";import{F as J}from"./index-121.js";import{$ as Ue,g as Oe,a as xe,c as Pe,b as nt}from"./oauthhel-259.js";import{I as it,a as be}from"./index.es-686.js";import{u as De,M as ct}from"./import-67.js";import{P as ot}from"./index-978.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const Y=p.createContext({appName:"untitled",appSlug:"untitled",connectionsTypes:[],isConnecting:!1,onConnectionChange:()=>{},setIsConnecting:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const B=p.createContext({isPopoverOpen:!1,setIsPopoverOpen:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function ee(){const{id:e}=ae(_e),t=ze(Ge),o=Fe(),{isPending:a,mutateAsync:n}=Ve({mutationFn:async c=>$e("connections/save",c,void 0,"POST"),mutationKey:["save_connection"],onSuccess:c=>{c.data&&(o.setQueryData(["connections",c.data.app_slug,"all"],h=>G(h||{data:[]},d=>{d.data.push(c.data)})),t(h=>G(h,d=>{const m=d[e];m!=null&&m.states&&(m.states.connections||(m.states.connections=[]),m.states.connections.push(c.data))})))}});return{isSavingConnection:a,saveConnection:n}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};async function te(e){if(!e)return!0;const{responseKeyMatch:t,responseMatch:o}=e;if(!t&&!o)return!1;const{data:a}=await Re(e);if(o){for(const[n,c]of Object.entries(o))if(ye.get(a,n)!==c)return!1}if(t){for(const n of t)if(!ye.has(a,n))return!1}return!0}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const ve={token:"",type:"bearer_token"};function lt({children:e,connectionConfig:t,connectionName:o}){var F,O,L,q;const[a,n]=p.useState(),{saveConnection:c}=ee(),{setIsPopoverOpen:h}=p.useContext(B),[d,m]=p.useState(ve),{appSlug:f,extraData:D,isConnecting:E,onConnectionAddChange:T,onConnectionChange:s,onConnectionSaveClick:y,onValidate:l,setIsConnecting:k}=p.useContext(Y),U=x=>{const{name:I,value:_}=x.target;m($=>{const w={...$,[I]:_};return T==null||T(w),w})},j=async(x,I)=>{try{const{data:_}=await c({app_slug:f,auth_details:x,auth_type:d.type,connection_name:o,encrypt_keys:I});h(!1),m(ve),s==null||s(_.id)}catch(_){console.error("Error in saving connection",_),n({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return S("form",{onSubmit:async x=>{if(x.preventDefault(),n(void 0),l&&l(d)===!1)return;y==null||y(d),k(!0),await te(t.verifyConnection)?await j({token:d.token,...D&&{extraData:D}},t.encryptKeys):n({token:{invalidMessage:"Invalid token",status:"error"}}),k(!1)},children:[e,i(K,{disabled:E,invalidMessage:(F=a==null?void 0:a.token)==null?void 0:F.invalidMessage,label:r("Token"),name:"token",onChange:U,required:!0,status:(O=a==null?void 0:a.token)==null?void 0:O.status,value:d.token,wrapperClassName:"mb-2"}),((L=a==null?void 0:a.saveConnection)==null?void 0:L.status)==="error"&&i(H.Paragraph,{type:"danger",children:(q=a==null?void 0:a.saveConnection)==null?void 0:q.invalidMessage}),S(J,{gap:8,justify:"end",children:[i(R,{onClick:()=>h(!1),children:r("Cancel")}),i(R,{disabled:E,htmlType:"submit",loading:E,type:"primary",children:r("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function rt(){const[e,t]=p.useState(!1),o=()=>{t(!0),setTimeout(()=>{t(!1)},2500)};return{copied:e,copy:n=>{if(window.isSecureContext&&navigator.clipboard){navigator.clipboard.writeText(n),o();return}const c=document.createElement("textarea");c.value=n,document.body.append(c),c.focus(),c.select();try{document.execCommand("copy"),o()}catch(h){console.error("Unable to copy to clipboard",h)}c.remove()}}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Compact:ht}=je,{useToken:dt}=ke;function qe({label:e,value:t,wrapperClassName:o,...a}){const{copied:n,copy:c}=rt(),{token:h}=dt(),d=p.useId();return S("div",{className:o,children:[e&&i("label",{className:"d-ib mb-1 font-medium",css:Ae({color:h.colorText},"",""),htmlFor:d,children:e}),S(ht,{className:"w-100",children:[i(it,{id:d,readOnly:!0,value:t,...a}),i(Se,{title:n?"Copied":"Copy",children:i(R,{"data-testid":"copy-button",icon:n?i(Le,{}):i(Ke,{}),onClick:()=>c(String(t))})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const Ce={clientId:"",clientSecret:"",type:"oauth2"};function ut({children:e,connectionConfig:t,connectionName:o}){var q,x,I,_,$;const[a,n]=p.useState(),{saveConnection:c}=ee(),[h,d]=Ne(Ue),{setIsPopoverOpen:m}=p.useContext(B),[f,D]=p.useState(Ce),{appSlug:E,extraData:T,isConnecting:s,onConnectionAddChange:y,onConnectionChange:l,onConnectionSaveClick:k,onValidate:U,setIsConnecting:j}=p.useContext(Y),N=w=>{const{name:C,value:A}=w.target;D(b=>{const u={...b,[C]:A};return y==null||y(u),u})},F=async(w,C)=>{try{const{data:A}=await c({app_slug:E,auth_details:w,auth_type:f.type,connection_name:o,encrypt_keys:C});l==null||l(A.id),D(Ce),m(!1)}catch(A){console.error("Can't save connection",A),n({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},O=async()=>{var w,C,A;try{let b=!1;switch((C=(w=t==null?void 0:t.tokenEndpoint)==null?void 0:w.bodyParams)==null?void 0:C.grant_type){case"authorization_code":{b=await xe(t,h);break}case"client_credentials":{b=await Oe(t.tokenEndpoint);break}default:throw new Error("Unsupported grant type for OAuth 2 connection")}if(!b)throw new Error("Client id or secret not correct!");if(t.verifyConnection&&!await te(et(t.verifyConnection,b)))throw new Error("Connection verification failed!");await F({...b,...T&&{extraData:T},client_id:f.clientId,client_secret:f.clientSecret,grant_type:(A=t==null?void 0:t.tokenEndpoint.bodyParams)==null?void 0:A.grant_type,refreshTokenUrl:t==null?void 0:t.refreshTokenUrl},t.encryptKeys)}catch(b){b instanceof Error&&n({oauth:{invalidMessage:b.message,status:"error"}}),console.error(b)}d({}),j(!1)},L=async()=>{var w,C;if(n(void 0),!(U&&U(f)===!1))switch(k==null||k(f),j(!0),(C=(w=t==null?void 0:t.tokenEndpoint)==null?void 0:w.bodyParams)==null?void 0:C.grant_type){case"authorization_code":{Pe(t,j);break}case"client_credentials":{O();break}default:j(!1)}};return De(()=>{Object.keys(h).length>0&&O()},400,[h]),S(Ie,{children:[e,i(qe,{label:r("Callback URL"),value:Ee.REDIRECT_URI,wrapperClassName:"mb-2"}),i(K,{disabled:s,label:r("Client Id"),name:"clientId",onChange:N,status:(q=a==null?void 0:a.oauth)==null?void 0:q.status,value:f.clientId,wrapperClassName:"mb-2"}),i(K,{disabled:s,invalidMessage:(x=a==null?void 0:a.oauth)==null?void 0:x.invalidMessage,label:r("Client Secret"),name:"clientSecret",onChange:N,status:(I=a==null?void 0:a.oauth)==null?void 0:I.status,value:f.clientSecret,wrapperClassName:"mb-2"}),((_=a==null?void 0:a.saveConnection)==null?void 0:_.status)==="error"&&i(H.Paragraph,{type:"danger",children:($=a==null?void 0:a.saveConnection)==null?void 0:$.invalidMessage}),S(J,{gap:8,justify:"end",children:[i(R,{onClick:()=>m(!1),children:r("Cancel")}),i(R,{disabled:s,loading:s,onClick:L,type:"primary",children:r("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const fe={addTo:"header",key:"",type:"api_key",value:""};function pt({children:e,connectionConfig:t,connectionName:o,customConnection:a}){var O,L,q,x,I,_,$,w;const[n,c]=p.useState(),{saveConnection:h}=ee(),{setIsPopoverOpen:d}=p.useContext(B),[m,f]=p.useState(fe),{appSlug:D,extraData:E,isConnecting:T,onConnectionAddChange:s,onConnectionChange:y,onConnectionSaveClick:l,onValidate:k,setIsConnecting:U}=p.useContext(Y),j=(C,A)=>{f(b=>{const u={...b,[C]:A};return s==null||s(u),u})},N=async(C,A)=>{try{const{data:b}=await h({app_slug:D,auth_details:C,auth_type:m.type,connection_name:o,encrypt_keys:A});d(!1),f(fe),y==null||y(b.id)}catch(b){console.error("Error in saving connection",b),c({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return S("form",{onSubmit:async C=>{if(C.preventDefault(),c(void 0),k&&k(m)===!1)return;if(l==null||l(m),U(!0),await te(t.verifyConnection)){const b={value:m.value,...E&&{extraData:E}};(a||(t==null?void 0:t.showKey)!==!1)&&(b.key=m.key),a&&(b.addTo=m.addTo),await N({...b},t.encryptKeys)}else c({value:{invalidMessage:"Invalid api key",status:"error"}});U(!1)},children:[e,(a||(t==null?void 0:t.showKey)!==!1)&&i(K,{disabled:T,invalidMessage:(O=n==null?void 0:n.key)==null?void 0:O.invalidMessage,label:r("Name"),onChange:C=>j("key",C.target.value),required:!0,status:(L=n==null?void 0:n.key)==null?void 0:L.status,value:m.key,wrapperClassName:"mb-2"}),i(K,{disabled:T,invalidMessage:(q=n==null?void 0:n.value)==null?void 0:q.invalidMessage,label:r("Value"),onChange:C=>j("value",C.target.value),required:!0,status:(x=n==null?void 0:n.value)==null?void 0:x.status,value:m.value,wrapperClassName:"mb-2"}),a&&i(X,{disabled:T,invalidMessage:(I=n==null?void 0:n.addTo)==null?void 0:I.invalidMessage,label:r("Add to"),onChange:C=>j("addTo",C),options:[{label:r("Header"),value:"header"},{label:r("Query Params"),value:"query_params"}],required:!0,status:(_=n==null?void 0:n.addTo)==null?void 0:_.status,value:m.addTo,wrapperClassName:"mb-2"}),(($=n==null?void 0:n.saveConnection)==null?void 0:$.status)==="error"&&i(H.Paragraph,{type:"danger",children:(w=n==null?void 0:n.saveConnection)==null?void 0:w.invalidMessage}),S(J,{gap:8,justify:"end",children:[i(R,{onClick:()=>d(!1),children:r("Cancel")}),i(R,{disabled:T,htmlType:"submit",loading:T,type:"primary",children:r("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const ge={password:"",type:"basic_auth",username:""};function mt({children:e,connectionConfig:t,connectionName:o}){var q,x,I,_,$,w;const[a,n]=p.useState(),[c,h]=p.useState(!1),{saveConnection:d}=ee(),{setIsPopoverOpen:m}=p.useContext(B),[f,D]=p.useState(ge),{appSlug:E,extraData:T,isConnecting:s,onConnectionAddChange:y,onConnectionChange:l,onConnectionSaveClick:k,onValidate:U,setIsConnecting:j}=p.useContext(Y),N=C=>{const{name:A,value:b}=C.target;D(u=>{const g={...u,[A]:b};return y==null||y(g),g})},F=async(C,A)=>{try{const{data:b}=await d({app_slug:E,auth_details:C,auth_type:f.type,connection_name:o,encrypt_keys:A});m(!1),D(ge),l==null||l(b.id)}catch(b){console.error("Error in saving connection",b),n({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},O=async C=>{if(C.preventDefault(),n(void 0),U&&U(f)===!1)return;k==null||k(f),j(!0),await te(t.verifyConnection)?await F({password:f.password,username:f.username,...T&&{extraData:T}},t.encryptKeys):n({password:{invalidMessage:"Invalid username or password",status:"error"},username:{status:"error"}}),j(!1)},L=()=>h(C=>!C);return S("form",{onSubmit:O,children:[e,(t==null?void 0:t.showUsername)!==!1&&i(K,{disabled:s,invalidMessage:(q=a==null?void 0:a.username)==null?void 0:q.invalidMessage,label:r("Key / Username"),name:"username",onChange:N,required:!0,status:(x=a==null?void 0:a.username)==null?void 0:x.status,value:f.username,wrapperClassName:"mb-2"}),(t==null?void 0:t.showPassword)!==!1&&S(je.Compact,{className:"w-full",children:[i(K,{disabled:s,invalidMessage:(I=a==null?void 0:a.password)==null?void 0:I.invalidMessage,label:r("Secret / Password"),name:"password",onChange:N,required:!0,status:(_=a==null?void 0:a.password)==null?void 0:_.status,type:c?"text":"password",value:f.password,wrapperClassName:"mb-2 w-full"}),i(R,{className:"mt-[1.625rem]",icon:c?i(Me,{}):i(Qe,{}),onClick:L})]}),(($=a==null?void 0:a.saveConnection)==null?void 0:$.status)==="error"&&i(H.Paragraph,{type:"danger",children:(w=a==null?void 0:a.saveConnection)==null?void 0:w.invalidMessage}),S(J,{gap:8,justify:"end",children:[i(R,{onClick:()=>m(!1),children:r("Cancel")}),i(R,{disabled:s,htmlType:"submit",loading:s,type:"primary",children:r("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function yt(e,t,o){const a={inputs:t,label:(o==null?void 0:o.label)||""},n=G(e,d=>{d.push(at(a))}),c=se(n),h=n.length-1;return{inputGroup:a,inputGroupIndex:h,newRepeaterField:n,values:c}}function we(e,t,o){const a=new Map(t.map(n=>[n.name,n]));return e.map(n=>({inputs:n.map(c=>{const h=a.get(c.name);return h?He(h,c):c}),label:(o==null?void 0:o.label)||""}))}function bt(e,t){const o=e[t],a=G(e,c=>{c.splice(t,1)}),n=se(a);return{inputGroup:o,repeaterFieldAfterDelete:a,values:n}}function vt(e,t,o,a){const n=G(e,h=>{const d=h[t].inputs[o];d.value=a,d.required&&(Array.isArray(a)&&a.length===0||!a)&&(d.invalidMessage=`${d.label} is required`)}),c=se(n);return{updatedRepeaterField:n,values:c}}function Ct(e){return e.componentName===Z.input}function ft(e){return e.componentName===Z.mixInput}function gt(e){return e.componentName===Z.select}function se(e){return e.map(t=>t.inputs.map(({disabled:o,name:a="",value:n})=>{const c={name:a,value:n};return o&&(c.disabled=o),c}))}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Paragraph:wt,Text:Tt}=H;function _t({addItemButtonLabel:e,additionalActions:t,deleteBtnProps:o,direction:a,fieldsMetaData:n,helperText:c,inputGroupProps:h,label:d,labelActionIconName:m,labelActionLoading:f,labelActionOnClick:D,labelActionText:E,maxGroup:T,minGroup:s=0,nonRemovableRows:y,onChange:l,onDelete:k,onRender:U,value:j,wrapperClassName:N}){const[F,O]=p.useState([]),{token:L}=ke.useToken(),q=()=>F.length<=s,x=()=>T!==void 0&&F.length>=T,I=p.useRef(!1);p.useEffect(()=>{const u=setTimeout(()=>{I.current=!0},100);return()=>{I.current=!1,clearTimeout(u)}},[]);const _=()=>{if(x())return;const{inputGroup:u,inputGroupIndex:g,newRepeaterField:P,values:V}=yt(F,n,h);O(P),l(V,u,g)},$=u=>()=>{if(q())return;const{inputGroup:g,repeaterFieldAfterDelete:P,values:V}=bt(F,u);O(P),l(V,g,u),k==null||k(u)},w=(u,g,P)=>{const{updatedRepeaterField:V,values:M}=vt(F,u,g,P);O(V);const Q=V[u];l(M,Q,u,g)},C=(u,g)=>P=>{const{value:V}=P.target;w(g,u,V)},A=(u,g)=>P=>{w(g,u,P)},b=(u,g)=>P=>{w(g,u,P)};return p.useEffect(()=>{O(we(j||[],n,h))},[n]),p.useEffect(()=>{O(we(j||[],n,h))},[j]),p.useEffect(()=>{U==null||U()},[]),S("div",{className:N,"data-testid":"repeater",children:[S(J,{className:de([!c&&"mb-1"]),justify:"space-between",children:[d&&i("label",{className:"d-ib font-medium",css:Ae({color:L.colorText},"",""),htmlFor:"repeater",children:d}),(E||m)&&i(R,{"aria-label":typeof E=="string"&&E||r("label-action"),icon:m&&i(We,{}),loading:f,onClick:D,size:"small",children:E})]}),c&&i(wt,{className:"mb-1",type:"secondary",children:c}),S(Ye,{children:[F.map((u,g)=>S(ue.div,{animate:{height:"auto",opacity:1},"data-testid":"repeater-input-group",exit:{height:0,opacity:0},initial:I.current&&{height:0,opacity:0},transition:{duration:.2},children:[S("div",{className:"mb-1 ml-3 flex items-center justify-between",children:[S(Tt,{children:[u!=null&&u.label&&u.label.includes("#{COUNT}")?u.label.replace("#{COUNT}",String(g+1)):u.label,!(u!=null&&u.label)&&Be(r("Item %d"),g+1)]}),S("div",{className:"flex items-center gap-2",children:[!(y!=null&&y.includes(g))&&i(R,{className:o==null?void 0:o.className,"data-testid":"delete-item",disabled:q(),icon:i(Xe,{}),onClick:$(g),size:"small",style:o==null?void 0:o.style}),t==null?void 0:t(g)]})]}),i("div",{className:de(["mb-3 ml-6",h==null?void 0:h.className,a==="vertical"?"space-y-2":"flex gap-2"]),style:h==null?void 0:h.style,children:u.inputs.map((P,V)=>{if(Ct(P)){const{componentName:M,...Q}=P;return i(K,{onChange:C(V,g),...Q},`${M}_${V+10}`)}if(gt(P)){const{componentName:M,...Q}=P;return i(X,{onChange:A(V,g),...Q},`${M}_${V+10}`)}if(ft(P)){const{componentName:M,...Q}=P;return i(ct,{onChange:b(V,g),...Q},`${M}_${V+10}`)}})})]},`inputGroup-${g+10}`)),i(ue.div,{layout:!0,transition:{duration:.2},children:i(R,{"data-testid":"add-item",disabled:x(),icon:i(Je,{}),onClick:_,children:e})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const kt=e=>e==null?void 0:e.reduce((t,o)=>{var c,h;const a=(c=o==null?void 0:o[0])==null?void 0:c.value,n=(h=o==null?void 0:o[1])==null?void 0:h.value;return a&&n&&(t[a]=n),t},{}),At=e=>{const t={method:"GET",queryParams:{client_id:e.clientId||"",response_type:"code"},url:e.authUrl||""};if(!t.queryParams)return t;e.scope&&(t.queryParams.scope=e.scope);const o=kt(e.queryParams);return o&&Object.keys(o).length&&Object.assign(t.queryParams,o),e.grantType==="authorization_code_pkce"&&(t.queryParams.code_challenge=e.codeVerifier||"",t.queryParams.code_challenge_method="plain"),t},Te=e=>{const t={bodyParams:{grant_type:e.grantType==="authorization_code_pkce"?"authorization_code":e.grantType},method:"POST",url:e.tokenUrl||""};return t.bodyParams&&(e.clientAuthentication==="body"?(t.bodyParams.client_id=e.clientId||"",t.bodyParams.client_secret=e.clientSecret||""):e.clientAuthentication==="header"&&(t.headers={Authorization:["Basic ",{encryption:"base64_encode",value:`${e.clientId}:${e.clientSecret}`}]}),e.grantType==="authorization_code_pkce"&&(t.bodyParams.code_verifier=e.codeVerifier||""),e.scope&&e.grantType==="client_credentials"&&(t.bodyParams.scope=e.scope)),t};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const jt={clientAuthentication:"body",grantType:"authorization_code"};function St({children:e,connectionConfig:t,connectionName:o}){var I,_,$,w,C,A,b,u,g,P,V,M,Q,ne,ie,ce,oe,le,re,he;const{appSlug:a,extraData:n,isConnecting:c,onConnectionChange:h,onValidate:d,setIsConnecting:m}=p.useContext(Y),{saveConnection:f}=ee(),[D,E]=Ne(Ue),{setIsPopoverOpen:T}=p.useContext(B),[s,y]=p.useState(),[l,k]=be(jt),[U,j]=be(t),N=(v,z)=>{k(W=>{W[v]=z,v==="grantType"&&z==="authorization_code_pkce"?W.codeVerifier=nt():v==="grantType"&&W.codeVerifier&&delete W.codeVerifier})},F=()=>{let v=U;switch(l.grantType){case"authorization_code":case"authorization_code_pkce":{j(z=>{z.authCodeEndpoint=At(l),z.tokenEndpoint=Te(l),v=me(z)});break}case"client_credentials":{j(z=>{z.tokenEndpoint=Te(l),v=me(z)});break}}return v},O=async(v,z)=>{try{const{data:W}=await f({app_slug:a,auth_details:v,auth_type:t.type,connection_name:o,encrypt_keys:z});h==null||h(W.id),j(t),T(!1)}catch(W){console.error("Can't save connection",W),y({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},L=async v=>{try{let z=!1;switch(l.grantType){case"authorization_code":case"authorization_code_pkce":{z=await xe(v,D);break}case"client_credentials":{z=await Oe(v.tokenEndpoint);break}default:throw new Error("Unsupported grant type for OAuth 2 connection")}if(!z)throw new Error("Client id or secret not correct!");await O({...z,...n&&{extraData:n},client_id:l.clientId,client_secret:l.clientSecret,clientAuthentication:l.clientAuthentication,grant_type:l.grantType,refreshTokenUrl:l.refreshTokenUrl||l.tokenUrl},v.encryptKeys)}catch(z){z instanceof Error&&y({clientId:{invalidMessage:z.message,status:"error"}}),console.error(z)}E({}),m(!1)},q=async()=>{const v=F();switch(m(!0),l.grantType){case"authorization_code":case"authorization_code_pkce":{Pe(v,m);break}case"client_credentials":{L(v);break}}},x=v=>{if(v.preventDefault(),v.stopPropagation(),y(void 0),!o){y({connectionName:{invalidMessage:"Connection name is required",status:"error"}});return}d&&d(U)===!1||q()};return De(()=>{Object.keys(D).length>0&&L(U)},400,[D]),S("form",{onSubmit:x,children:[e,i(X,{"aria-required":!0,disabled:c,invalidMessage:(I=s==null?void 0:s.grant_type)==null?void 0:I.invalidMessage,label:r("Grant Type"),onChange:v=>N("grantType",v),options:[{label:r("Authorization Code"),value:"authorization_code"},{label:r("Authorization Code with PKCE"),value:"authorization_code_pkce"},{label:r("Client Credentials"),value:"client_credentials"}],required:!0,status:(_=s==null?void 0:s.grant_type)==null?void 0:_.status,value:l.grantType,wrapperClassName:"mb-2"}),S(pe,{conditions:l.grantType.startsWith("authorization_code"),children:[i(qe,{label:r("Callback URL"),value:Ee.REDIRECT_URI,wrapperClassName:"mb-2"}),i(K,{disabled:c,invalidMessage:($=s==null?void 0:s.authUrl)==null?void 0:$.invalidMessage,label:r("Authorization URL"),name:"authUrl",onChange:v=>N("authUrl",v.target.value),required:!0,status:(w=s==null?void 0:s.authUrl)==null?void 0:w.status,type:"url",value:l.authUrl,wrapperClassName:"mb-2"})]}),i(K,{disabled:c,invalidMessage:(C=s==null?void 0:s.tokenUrl)==null?void 0:C.invalidMessage,label:r("Access Token URL"),name:"tokenUrl",onChange:v=>N("tokenUrl",v.target.value),required:!0,status:(A=s==null?void 0:s.tokenUrl)==null?void 0:A.status,type:"url",value:l.tokenUrl,wrapperClassName:"mb-2"}),i(K,{disabled:c,helperText:r("if not provided, the token URL will be used to refresh the token"),invalidMessage:(b=s==null?void 0:s.refreshTokenUrl)==null?void 0:b.invalidMessage,label:r("Refresh Token URL"),name:"refreshTokenUrl",onChange:v=>N("refreshTokenUrl",v.target.value),status:(u=s==null?void 0:s.refreshTokenUrl)==null?void 0:u.status,type:"url",value:l.refreshTokenUrl,wrapperClassName:"mb-2"}),i(K,{disabled:c,invalidMessage:(g=s==null?void 0:s.clientId)==null?void 0:g.invalidMessage,label:r("Client Id"),name:"clientId",onChange:v=>N("clientId",v.target.value),required:!0,status:(P=s==null?void 0:s.clientId)==null?void 0:P.status,value:l.clientId,wrapperClassName:"mb-2"}),i(K,{disabled:c,invalidMessage:(V=s==null?void 0:s.clientSecret)==null?void 0:V.invalidMessage,label:r("Client Secret"),name:"clientSecret",onChange:v=>N("clientSecret",v.target.value),required:!0,status:(M=s==null?void 0:s.clientSecret)==null?void 0:M.status,value:l.clientSecret,wrapperClassName:"mb-2"}),i(K,{disabled:c,invalidMessage:(Q=s==null?void 0:s.scope)==null?void 0:Q.invalidMessage,label:r("Scope"),name:"scope",onChange:v=>N("scope",v.target.value),status:(ne=s==null?void 0:s.scope)==null?void 0:ne.status,value:l.scope,wrapperClassName:"mb-2"}),i(pe,{conditions:l.grantType.startsWith("authorization_code"),children:i(_t,{addItemButtonLabel:r("Add"),fieldsMetaData:[{componentName:Z.input,name:"key",placeholder:r("Key"),value:""},{componentName:Z.input,name:"value",placeholder:r("Value"),value:""}],label:r("Additional Query Params"),onChange:v=>N("queryParams",v),value:l.queryParams,wrapperClassName:"mb-2"})}),i(X,{disabled:c,invalidMessage:(ie=s==null?void 0:s.clientAuthentication)==null?void 0:ie.invalidMessage,label:r("Client Authentication"),onChange:v=>N("clientAuthentication",v),options:[{label:r("Send as Basic Auth header"),value:"header"},{label:r("Send Client Credentials in body"),value:"body"}],required:!0,status:(ce=s==null?void 0:s.clientAuthentication)==null?void 0:ce.status,value:l.clientAuthentication,wrapperClassName:"mb-2"}),((oe=s==null?void 0:s.saveConnection)==null?void 0:oe.status)==="error"&&i(H.Paragraph,{type:"danger",children:(le=s==null?void 0:s.saveConnection)==null?void 0:le.invalidMessage}),((re=s==null?void 0:s.connectionName)==null?void 0:re.status)==="error"&&i(H.Paragraph,{type:"danger",children:(he=s==null?void 0:s.connectionName)==null?void 0:he.invalidMessage}),S(J,{gap:8,justify:"end",children:[i(R,{onClick:()=>T(!1),children:r("Cancel")}),i(R,{disabled:c,htmlType:"submit",loading:c,type:"primary",children:r("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Text:Nt}=H;function It({children:e}){const[t,o]=p.useState(""),[a,n]=p.useState(""),{addConnectionHelpingText:c,appName:h,connectionsTypes:d,customConnection:m,isConnecting:f}=p.useContext(Y),D=p.useMemo(()=>d.map(y=>({label:y.label,value:y.type})),[d]),E=y=>{const{value:l}=y.target;o(l)},T=y=>{n(y)},s=y=>{const l=d.find(k=>k.type===y);if(!l)throw new Error("Connection type not found");return l};return p.useEffect(()=>{h&&o(`${h} connection`)},[h]),p.useEffect(()=>{d.length===1&&n(d[0].type)},[]),S(Ie,{children:[i(X,{"aria-readonly":(d==null?void 0:d.length)===1,disabled:f||(d==null?void 0:d.length)===1,label:r("Connection type"),onChange:T,options:D,placeholder:r("Choose type"),value:a,wrapperClassName:"mb-2"}),i(K,{disabled:f,label:r("Connection Name"),name:"connectionName",onChange:E,required:!0,value:t,wrapperClassName:"mb-2"}),c&&i("div",{className:"mb-2",children:i(Nt,{type:"secondary",children:i("span",{dangerouslySetInnerHTML:{__html:c}})})}),m&&a==="oauth2"&&i(St,{connectionConfig:s("oauth2"),connectionName:t,children:e}),!m&&a==="oauth2"&&i(ut,{connectionConfig:s("oauth2"),connectionName:t,children:e}),a==="bearer_token"&&i(lt,{connectionConfig:s("bearer_token"),connectionName:t,children:e}),a==="api_key"&&i(pt,{connectionConfig:s("api_key"),connectionName:t,customConnection:m,children:e}),a==="basic_auth"&&i(mt,{connectionConfig:s("basic_auth"),connectionName:t,children:e})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function Et({children:e}){const{isPopoverOpen:t,setIsPopoverOpen:o}=p.useContext(B),a=()=>{o(c=>!c)};return i(ot,{content:i(It,{children:e}),destroyTooltipOnHide:!0,open:t,placement:"right",styles:{body:{maxHeight:"100vh",maxWidth:400,overflowY:"auto"}},title:i(Ut,{popoverClose:()=>{o(!1)}}),children:i(Se,{title:r("Add new connection"),children:i(R,{onClick:a,children:r("Add Connection")})})})}function Ut({popoverClose:e}){return S(st,{justify:"space-between",children:[i(H.Title,{level:5,style:{marginBottom:0},children:r("Add New Connection")}),i(R,{icon:i(Ze,{}),onClick:e,size:"small",type:"text"})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function Mt({addConnectionHelpingText:e,allowClear:t,appName:o,appSlug:a,children:n,connectionOptionsProp:c,connectionsTypes:h,customConnection:d,extraData:m,helpingText:f,invalidMessage:D,label:E=r("Connection"),loading:T=!1,onConnectionAddChange:s,onConnectionChange:y,onConnectionSaveClick:l,onRender:k,onValidate:U,status:j,value:N,wrapperClassName:F}){const[O,L]=p.useState(!1),[q,x]=p.useState(!1),{id:I}=ae(_e),{states:_}=ae(tt(I)),$=p.useMemo(()=>{var b;return(b=_==null?void 0:_.connections)==null?void 0:b.map(u=>({label:u.connection_name,value:u.id}))},[_==null?void 0:_.connections]),w=p.useMemo(()=>({isPopoverOpen:q,setIsPopoverOpen:x}),[q]),C=p.useMemo(()=>({addConnectionHelpingText:e,appName:o,appSlug:a,connectionsTypes:h,customConnection:d,extraData:m,isConnecting:O,onConnectionAddChange:s,onConnectionChange:y,onConnectionSaveClick:l,onValidate:U,setIsConnecting:L}),[e,o,a,h,d,m,O,s,y,l,U]),A=b=>{y==null||y(b)};return p.useEffect(()=>{k==null||k()},[]),i(X,{allowClear:t,disabled:T||q,helperText:f,invalidMessage:D,label:E,loading:T,onChange:A,optionFilterProp:"label",options:c||$,placeholder:r("Choose a connection"),showSearch:!0,status:j,suffix:i(Y.Provider,{value:C,children:i(B.Provider,{value:w,children:i(Et,{children:n})})}),value:N,wrapperClassName:`w-100 ${F}`})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};export{Mt as C,qe as I,_t as R};

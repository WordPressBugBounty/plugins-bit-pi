import{r as u,w as de,ax as Ne,f as Me,aw as Le,h as Re,q as Ke,C as ee,db as He,a as w,j as s,_ as h,B as $,t as ce,l as le,S as Se,af as oe,cN as Qe,aB as We,d as Ee,F as Ie,z as De,dc as Be,dd as Xe,m as X,b9 as xe,s as Ue,de as Ye,av as Ze,da as Je,cg as Ge,aZ as be,aC as et,o as tt,L as at,y as ye,df as fe}from"./main-chatty-months-shout.js";import{f as st,a8 as nt,O as ne,q as it}from"./_applist-chatty-months-shout-814.js";import{S as te}from"./index-chatty-months-shout-544.js";import{l as Ce}from"./lodash-chatty-months-shout-731.js";import{I as R}from"./index-chatty-months-shout-138.js";import{T as B,R as ct}from"./index-chatty-months-shout-83.js";import{F as ae}from"./index-chatty-months-shout-621.js";import{$ as Pe,g as Oe,a as qe,c as ze,b as lt}from"./oauthhel-chatty-months-shout-704.js";import{I as ot}from"./index-chatty-months-shout-289.js";import{u as Fe}from"./import-chatty-months-shout-469.js";import{M as rt}from"./index-chatty-months-shout-783.js";import{a as ve}from"./index.es-chatty-months-shout-658.js";import{P as ht}from"./index-chatty-months-shout-969.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const J=u.createContext({appName:"untitled",appSlug:"untitled",connectionsTypes:[],isConnecting:!1,onConnectionChange:()=>{},setIsConnecting:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const G=u.createContext({isPopoverOpen:!1,setIsPopoverOpen:()=>{}});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function ie(){const{id:e}=de(Ne),t=Me(st),l=Le(),{isPending:a,mutateAsync:i}=Re({mutationFn:async c=>Ke("connections/save",c,void 0,"POST"),mutationKey:["save_connection"],onSuccess:c=>{c.data&&(l.setQueryData(["connections",c.data.app_slug,"all"],o=>ee(o||{data:[]},r=>{r.data.push(c.data)})),t(o=>ee(o,r=>{const p=r[e];p!=null&&p.states&&(p.states.connections||(p.states.connections=[]),p.states.connections.push(c.data))})))}});return{isSavingConnection:a,saveConnection:i}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};async function re(e){if(!e)return!0;const{responseKeyMatch:t,responseMatch:l}=e;if(!t&&!l)return!1;const{data:a}=await He(e);if(l){for(const[i,c]of Object.entries(l))if(Ce.get(a,i)!==c)return!1}if(t){for(const i of t)if(!Ce.has(a,i))return!1}return!0}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const ge={token:"",type:"bearer_token"};function dt({children:e,connectionConfig:t,connectionName:l}){var K,D,O,F;const[a,i]=u.useState(),{saveConnection:c}=ie(),{setIsPopoverOpen:o}=u.useContext(G),[r,p]=u.useState(ge),{appSlug:v,extraData:E,isConnecting:V,onConnectionAddChange:T,onConnectionChange:n,onConnectionSaveClick:b,onValidate:d,setIsConnecting:_}=u.useContext(J),P=U=>{const{name:q,value:k}=U.target;p(M=>{const A={...M,[q]:k};return T==null||T(A),A})},I=async(U,q)=>{try{const{data:k}=await c({app_slug:v,auth_details:U,auth_type:r.type,connection_name:l,encrypt_keys:q});o(!1),p(ge),n==null||n(k.id)}catch(k){console.error("Error in saving connection",k),i({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return w("form",{onSubmit:async U=>{if(U.preventDefault(),U.stopPropagation(),i(void 0),d&&d(r)===!1)return;b==null||b(r),_(!0),await re(t.verifyConnection)?await I({token:r.token,...E&&{extraData:E}},t.encryptKeys):i({token:{invalidMessage:"Invalid token",status:"error"}}),_(!1)},children:[e,s(R,{disabled:V,invalidMessage:(K=a==null?void 0:a.token)==null?void 0:K.invalidMessage,label:h("Token"),name:"token",onChange:P,required:!0,status:(D=a==null?void 0:a.token)==null?void 0:D.status,value:r.token,wrapperClassName:"mb-2"}),((O=a==null?void 0:a.saveConnection)==null?void 0:O.status)==="error"&&s(B.Paragraph,{type:"danger",children:(F=a==null?void 0:a.saveConnection)==null?void 0:F.invalidMessage}),w(ae,{gap:8,justify:"end",children:[s($,{onClick:()=>o(!1),children:h("Cancel")}),s($,{disabled:V,htmlType:"submit",loading:V,type:"primary",children:h("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function ut(){const[e,t]=u.useState(!1),l=()=>{t(!0),setTimeout(()=>{t(!1)},2500)};return{copied:e,copy:i=>{if(window.isSecureContext&&navigator.clipboard){navigator.clipboard.writeText(i),l();return}const c=document.createElement("textarea");c.value=i,document.body.append(c),c.focus(),c.select();try{document.execCommand("copy"),l()}catch(o){console.error("Unable to copy to clipboard",o)}c.remove()}}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Compact:pt}=Se,{useToken:mt}=ce;function Ve({label:e,value:t,wrapperClassName:l,...a}){const{copied:i,copy:c}=ut(),{token:o}=mt(),r=u.useId();return w("div",{className:l,children:[e&&s("label",{className:"d-ib mb-1 font-medium",css:le({color:o.colorText},"",""),htmlFor:r,children:e}),w(pt,{className:"w-100",children:[s(ot,{id:r,readOnly:!0,value:t,...a}),s(oe,{title:i?"Copied":"Copy",children:s($,{"data-testid":"copy-button",icon:i?s(Qe,{}):s(We,{}),onClick:()=>c(String(t))})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const we={clientId:"",clientSecret:"",type:"oauth2"};function bt({children:e,connectionConfig:t,connectionName:l}){var F,U,q,k,M;const[a,i]=u.useState(),{saveConnection:c}=ie(),[o,r]=Ee(Pe),{setIsPopoverOpen:p}=u.useContext(G),[v,E]=u.useState(we),{appSlug:V,extraData:T,isConnecting:n,onConnectionAddChange:b,onConnectionChange:d,onConnectionSaveClick:_,onValidate:P,setIsConnecting:I}=u.useContext(J),N=A=>{const{name:m,value:j}=A.target;E(y=>{const L={...y,[m]:j};return b==null||b(L),L})},K=async(A,m)=>{try{const{data:j}=await c({app_slug:V,auth_details:A,auth_type:v.type,connection_name:l,encrypt_keys:m});d==null||d(j.id),E(we),p(!1)}catch(j){console.error("Can't save connection",j),i({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},D=async()=>{var A,m,j;try{let y=!1;switch((m=(A=t==null?void 0:t.tokenEndpoint)==null?void 0:A.bodyParams)==null?void 0:m.grant_type){case"authorization_code":{y=await qe(t,o);break}case"client_credentials":{y=await Oe(t.tokenEndpoint);break}default:throw new Error("Unsupported grant type for OAuth 2 connection")}if(!y)throw new Error("Client id or secret not correct!");if(t.verifyConnection&&!await re(nt(t.verifyConnection,y)))throw new Error("Connection verification failed!");await K({...y,...T&&{extraData:T},client_id:v.clientId,client_secret:v.clientSecret,grant_type:(j=t==null?void 0:t.tokenEndpoint.bodyParams)==null?void 0:j.grant_type,refreshTokenUrl:t==null?void 0:t.refreshTokenUrl},t.encryptKeys)}catch(y){y instanceof Error&&i({oauth:{invalidMessage:y.message,status:"error"}}),console.error(y)}r({}),I(!1)},O=async()=>{var A,m;if(i(void 0),!(P&&P(v)===!1))switch(_==null||_(v),I(!0),(m=(A=t==null?void 0:t.tokenEndpoint)==null?void 0:A.bodyParams)==null?void 0:m.grant_type){case"authorization_code":{ze(t,I);break}case"client_credentials":{D();break}default:I(!1)}};return Fe(()=>{Object.keys(o).length>0&&D()},400,[o]),w(Ie,{children:[e,s(Ve,{label:h("Callback URL"),value:De.REDIRECT_URI,wrapperClassName:"mb-2"}),s(R,{disabled:n,label:h("Client Id"),name:"clientId",onChange:N,status:(F=a==null?void 0:a.oauth)==null?void 0:F.status,value:v.clientId,wrapperClassName:"mb-2"}),s(R,{disabled:n,invalidMessage:(U=a==null?void 0:a.oauth)==null?void 0:U.invalidMessage,label:h("Client Secret"),name:"clientSecret",onChange:N,status:(q=a==null?void 0:a.oauth)==null?void 0:q.status,value:v.clientSecret,wrapperClassName:"mb-2"}),((k=a==null?void 0:a.saveConnection)==null?void 0:k.status)==="error"&&s(B.Paragraph,{type:"danger",children:(M=a==null?void 0:a.saveConnection)==null?void 0:M.invalidMessage}),w(ae,{gap:8,justify:"end",children:[s($,{onClick:()=>p(!1),children:h("Cancel")}),s($,{disabled:n,loading:n,onClick:O,type:"primary",children:h("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const Te={addTo:"header",key:"",type:"api_key",value:""};function yt({children:e,connectionConfig:t,connectionName:l,customConnection:a}){var D,O,F,U,q,k,M,A;const[i,c]=u.useState(),{saveConnection:o}=ie(),{setIsPopoverOpen:r}=u.useContext(G),[p,v]=u.useState(Te),{appSlug:E,extraData:V,isConnecting:T,onConnectionAddChange:n,onConnectionChange:b,onConnectionSaveClick:d,onValidate:_,setIsConnecting:P}=u.useContext(J),I=(m,j)=>{v(y=>{const L={...y,[m]:j};return n==null||n(L),L})},N=async(m,j)=>{try{const{data:y}=await o({app_slug:E,auth_details:m,auth_type:p.type,connection_name:l,encrypt_keys:j});r(!1),v(Te),b==null||b(y.id)}catch(y){console.error("Error in saving connection",y),c({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}};return w("form",{onSubmit:async m=>{if(m.preventDefault(),m.stopPropagation(),c(void 0),_&&_(p)===!1)return;if(d==null||d(p),P(!0),await re(t.verifyConnection)){const y={value:p.value,...V&&{extraData:V}};(a||(t==null?void 0:t.showKey)!==!1)&&(y.key=p.key),a&&(y.addTo=p.addTo),await N({...y},t.encryptKeys)}else c({value:{invalidMessage:"Invalid api key",status:"error"}});P(!1)},children:[e,(a||(t==null?void 0:t.showKey)!==!1)&&s(R,{disabled:T,invalidMessage:(D=i==null?void 0:i.key)==null?void 0:D.invalidMessage,label:(t==null?void 0:t.keyLabel)||h("Name"),onChange:m=>I("key",m.target.value),required:!0,status:(O=i==null?void 0:i.key)==null?void 0:O.status,value:p.key,wrapperClassName:"mb-2"}),s(R,{disabled:T,invalidMessage:(F=i==null?void 0:i.value)==null?void 0:F.invalidMessage,label:(t==null?void 0:t.valueLabel)||h("Value"),onChange:m=>I("value",m.target.value),required:!0,status:(U=i==null?void 0:i.value)==null?void 0:U.status,value:p.value,wrapperClassName:"mb-2"}),a&&s(te,{disabled:T,invalidMessage:(q=i==null?void 0:i.addTo)==null?void 0:q.invalidMessage,label:h("Add to"),onChange:m=>I("addTo",m),options:[{label:h("Header"),value:"header"},{label:h("Query Params"),value:"query_params"}],required:!0,status:(k=i==null?void 0:i.addTo)==null?void 0:k.status,value:p.addTo,wrapperClassName:"mb-2"}),((M=i==null?void 0:i.saveConnection)==null?void 0:M.status)==="error"&&s(B.Paragraph,{type:"danger",children:(A=i==null?void 0:i.saveConnection)==null?void 0:A.invalidMessage}),w(ae,{gap:8,justify:"end",children:[s($,{onClick:()=>r(!1),children:h("Cancel")}),s($,{disabled:T,htmlType:"submit",loading:T,type:"primary",children:h("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const ke={password:"",type:"basic_auth",username:""};function ft({children:e,connectionConfig:t,connectionName:l}){var F,U,q,k,M,A;const[a,i]=u.useState(),[c,o]=u.useState(!1),{saveConnection:r}=ie(),{setIsPopoverOpen:p}=u.useContext(G),[v,E]=u.useState(ke),{appSlug:V,extraData:T,isConnecting:n,onConnectionAddChange:b,onConnectionChange:d,onConnectionSaveClick:_,onValidate:P,setIsConnecting:I}=u.useContext(J),N=m=>{const{name:j,value:y}=m.target;E(L=>{const Y={...L,[j]:y};return b==null||b(Y),Y})},K=async(m,j)=>{try{const{data:y}=await r({app_slug:V,auth_details:m,auth_type:v.type,connection_name:l,encrypt_keys:j});p(!1),E(ke),d==null||d(y.id)}catch(y){console.error("Error in saving connection",y),i({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},D=async m=>{if(m.preventDefault(),m.stopPropagation(),i(void 0),P&&P(v)===!1)return;_==null||_(v),I(!0),await re(t.verifyConnection)?await K({password:v.password,username:v.username,...T&&{extraData:T}},t.encryptKeys):i({password:{invalidMessage:"Invalid username or password",status:"error"},username:{status:"error"}}),I(!1)},O=()=>o(m=>!m);return w("form",{onSubmit:D,children:[e,(t==null?void 0:t.showUsername)!==!1&&s(R,{disabled:n,invalidMessage:(F=a==null?void 0:a.username)==null?void 0:F.invalidMessage,label:h("Key / Username"),name:"username",onChange:N,required:!0,status:(U=a==null?void 0:a.username)==null?void 0:U.status,value:v.username,wrapperClassName:"mb-2"}),(t==null?void 0:t.showPassword)!==!1&&w(Se.Compact,{className:"w-full",children:[s(R,{disabled:n,invalidMessage:(q=a==null?void 0:a.password)==null?void 0:q.invalidMessage,label:h("Secret / Password"),name:"password",onChange:N,required:!0,status:(k=a==null?void 0:a.password)==null?void 0:k.status,type:c?"text":"password",value:v.password,wrapperClassName:"mb-2 w-full"}),s($,{className:"mt-[1.625rem]",icon:c?s(Be,{}):s(Xe,{}),onClick:O})]}),((M=a==null?void 0:a.saveConnection)==null?void 0:M.status)==="error"&&s(B.Paragraph,{type:"danger",children:(A=a==null?void 0:a.saveConnection)==null?void 0:A.invalidMessage}),w(ae,{gap:8,justify:"end",children:[s($,{onClick:()=>p(!1),children:h("Cancel")}),s($,{disabled:n,htmlType:"submit",loading:n,type:"primary",children:h("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function $e({icon:e,iconSize:t,label:l,onRender:a,text:i,tooltip:c,wrapperClassName:o,...r}){const p=u.useId(),{token:v}=ce.useToken(),E=e||void 0;return u.useEffect(()=>{a==null||a()},[]),w("div",{className:o,children:[s("label",{className:"d-ib mb-1",css:le({color:v.colorText,minHeight:22},"",""),htmlFor:p,children:l||""}),s(oe,{title:c,children:s($,{id:p,...E?{icon:s(E,{size:t})}:{},"data-testid":"btnComponent",...r,children:i})})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function Ct({label:e,onClear:t}){const{token:l}=ce.useToken();return w("div",{className:X("w-100"),children:[e&&s("label",{className:"d-b mb-1 font-medium",css:le({color:l.colorText},"",""),children:e}),w("div",{className:X(["flex h-8 items-center justify-between rounded-[10px] px-2","bg-gray-100 dark:bg-gray-800","border border-gray-300 dark:border-gray-700"]),children:[w("div",{className:"flex flex-1 items-center gap-2",children:[s(xe,{className:"text-gray-500 dark:text-gray-400",size:16}),w(B.Text,{className:"text-xs text-gray-600 dark:text-gray-300",children:[h("Defined automatically by the")," ",s("strong",{children:h("model")})]})]}),s($e,{danger:!0,icon:Ue,onClick:t,size:"small",type:"text"})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function vt({children:e,isTool:t,label:l,magicButtonClassName:a,modelDefined:i,onDisableModelDefined:c,onEnableModelDefined:o,wrapperClassName:r}){return t?i?s(Ct,{label:l,onClear:c}):w("div",{className:X("w-100 flex gap-1",r),children:[e,s(oe,{title:h("Let the model define this parameter"),children:s($e,{className:X(l&&"top-6",a),icon:xe,onClick:o})})]}):e}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function gt(e,t,l){const a={inputs:t,label:(l==null?void 0:l.label)||""},i=ee(e,r=>{r.push(Ze(a))}),c=he(i),o=i.length-1;return{inputGroup:a,inputGroupIndex:o,newRepeaterField:i,values:c}}function _e(e,t,l){const a=new Map(t.map(i=>[i.name,i]));return e.map(i=>({inputs:i.map(c=>{const o=a.get(c.name);return o?Ye(o,c):c}),label:(l==null?void 0:l.label)||""}))}function wt(e,t){const l=e[t],a=ee(e,c=>{c.splice(t,1)}),i=he(a);return{inputGroup:l,repeaterFieldAfterDelete:a,values:i}}function Tt(e,t,l,a){const i=ee(e,o=>{const r=o[t].inputs[l];r.value=a,r.required&&(Array.isArray(a)&&a.length===0||!a)&&(r.invalidMessage=`${r.label} is required`)}),c=he(i);return{updatedRepeaterField:i,values:c}}function kt(e){return e.componentName===ne.input}function Ae(e){return e.componentName===ne.mixInput}function _t(e){return e.componentName===ne.select}function he(e){return e.map(t=>t.inputs.map(({disabled:l,name:a="",value:i,...c})=>{const o={name:a,value:i};return l&&(o.disabled=l),"modelDefined"in c&&c.modelDefined===!0&&(o.modelDefined=!0,"required"in c&&c.required===!0&&(o.required=!0)),o}))}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Paragraph:At,Text:jt}=B;function Nt({addItemButtonLabel:e,additionalActions:t,deleteBtnProps:l,direction:a,fieldsMetaData:i,helperText:c,inputGroupProps:o,isTool:r=!1,label:p,labelActionIconName:v,labelActionLoading:E,labelActionOnClick:V,labelActionText:T,maxGroup:n,minGroup:b=0,nonRemovableRows:d,onChange:_,onDelete:P,onRender:I,value:N,wrapperClassName:K}){const[D,O]=u.useState([]),{token:F}=ce.useToken(),U=()=>D.length<=b,q=()=>n!==void 0&&D.length>=n,k=u.useRef(!1);u.useEffect(()=>{const C=setTimeout(()=>{k.current=!0},100);return()=>{k.current=!1,clearTimeout(C)}},[]);const M=()=>{if(q())return;const{inputGroup:C,inputGroupIndex:g,newRepeaterField:x,values:S}=gt(D,i,o);O(x),_(S,C,g)},A=C=>()=>{if(U())return;const{inputGroup:g,repeaterFieldAfterDelete:x,values:S}=wt(D,C);O(x),_(S,g,C),P==null||P(C)},m=(C,g,x)=>{const{updatedRepeaterField:S,values:H}=Tt(D,C,g,x);O(S);const Q=S[C];_(H,Q,C,g)},j=(C,g)=>x=>{const{value:S}=x.target;m(g,C,S)},y=(C,g)=>x=>{m(g,C,x)},L=(C,g)=>x=>{m(g,C,x)},Y=(C,g)=>x=>{const S=ee(D,W=>{const se=W[C].inputs[g];Ae(se)&&(se.modelDefined=x)});O(S);const H=S[C],Q=he(S);_(Q,H,C,g)};return u.useEffect(()=>{O(_e(N||[],i,o))},[i]),u.useEffect(()=>{O(_e(N||[],i,o))},[N]),u.useEffect(()=>{I==null||I()},[]),w("div",{className:K,"data-testid":"repeater",children:[w(ae,{className:X([!c&&"mb-1"]),justify:"space-between",children:[p&&s("label",{className:"d-ib font-medium",css:le({color:F.colorText},"",""),htmlFor:"repeater",children:p}),(T||v)&&s($,{"aria-label":typeof T=="string"&&T||h("label-action"),icon:v&&s(Je,{}),loading:E,onClick:V,size:"small",children:T})]}),c&&s(At,{className:"mb-1",type:"secondary",children:c}),w(Ge,{children:[D.map((C,g)=>w(be.div,{animate:{height:"auto",opacity:1},"data-testid":"repeater-input-group",exit:{height:0,opacity:0},initial:k.current&&{height:0,opacity:0},transition:{duration:.2},children:[w("div",{className:"mb-1 ml-3 flex items-center justify-between",children:[w(jt,{children:[C!=null&&C.label&&C.label.includes("#{COUNT}")?C.label.replace("#{COUNT}",String(g+1)):C.label,!(C!=null&&C.label)&&et(h("Item %d"),g+1)]}),w("div",{className:"flex items-center gap-2",children:[t==null?void 0:t(g),!(d!=null&&d.includes(g))&&s($,{className:l==null?void 0:l.className,"data-testid":"delete-item",disabled:U(),icon:s(tt,{}),onClick:A(g),size:"small",style:l==null?void 0:l.style})]})]}),s("div",{className:X(["mb-3 ml-6",o==null?void 0:o.className,a==="vertical"?"space-y-2":"flex gap-2"]),style:o==null?void 0:o.style,children:C.inputs.map((x,S)=>{if(kt(x)){const{componentName:H,...Q}=x;return s(R,{onChange:j(S,g),...Q},`${H}_${S+10}`)}if(_t(x)){const{componentName:H,...Q}=x;return s(te,{onChange:y(S,g),...Q},`${H}_${S+10}`)}if(Ae(x)){const{componentName:H,modelDefined:Q,...W}=x;return s(vt,{isTool:r,label:W.label,modelDefined:Q,onDisableModelDefined:()=>Y(g,S)(!1),onEnableModelDefined:()=>Y(g,S)(!0),wrapperClassName:X(W.wrapperClassName,r&&"w-100"),children:s(rt,{onChange:L(S,g),...W,className:X(W.className,r&&"flex-1"),wrapperClassName:X(W.wrapperClassName,r&&"w-100")})},`${H}_${S+10}`)}})})]},`inputGroup-${g+10}`)),s(be.div,{transition:{duration:.2},children:s($,{"data-testid":"add-item",disabled:q(),icon:s(at,{}),onClick:M,children:e})})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const St=e=>e==null?void 0:e.reduce((t,l)=>{var c,o;const a=(c=l==null?void 0:l[0])==null?void 0:c.value,i=(o=l==null?void 0:l[1])==null?void 0:o.value;return a&&i&&(t[a]=i),t},{}),Et=e=>{const t={method:"GET",queryParams:{client_id:e.clientId||"",response_type:"code"},url:e.authUrl||""};if(!t.queryParams)return t;e.scope&&(t.queryParams.scope=e.scope);const l=St(e.queryParams);return l&&Object.keys(l).length&&Object.assign(t.queryParams,l),e.grantType==="authorization_code_pkce"&&(t.queryParams.code_challenge=e.codeVerifier||"",t.queryParams.code_challenge_method="plain"),t},je=e=>{const t={bodyParams:{grant_type:e.grantType==="authorization_code_pkce"?"authorization_code":e.grantType},method:"POST",url:e.tokenUrl||""};return t.bodyParams&&(e.clientAuthentication==="body"?(t.bodyParams.client_id=e.clientId||"",t.bodyParams.client_secret=e.clientSecret||""):e.clientAuthentication==="header"&&(t.headers={Authorization:["Basic ",{encryption:"base64_encode",value:`${e.clientId}:${e.clientSecret}`}]}),e.grantType==="authorization_code_pkce"&&(t.bodyParams.code_verifier=e.codeVerifier||""),e.scope&&e.grantType==="client_credentials"&&(t.bodyParams.scope=e.scope)),t};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const It={clientAuthentication:"body",grantType:"authorization_code"};function Dt({children:e,connectionConfig:t,connectionName:l}){var q,k,M,A,m,j,y,L,Y,C,g,x,S,H,Q,W,se,ue,pe,me;const{appSlug:a,extraData:i,isConnecting:c,onConnectionChange:o,onValidate:r,setIsConnecting:p}=u.useContext(J),{saveConnection:v}=ie(),[E,V]=Ee(Pe),{setIsPopoverOpen:T}=u.useContext(G),[n,b]=u.useState(),[d,_]=ve(It),[P,I]=ve(t),N=(f,z)=>{_(Z=>{Z[f]=z,f==="grantType"&&z==="authorization_code_pkce"?Z.codeVerifier=lt():f==="grantType"&&Z.codeVerifier&&delete Z.codeVerifier})},K=()=>{let f=P;switch(d.grantType){case"authorization_code":case"authorization_code_pkce":{I(z=>{z.authCodeEndpoint=Et(d),z.tokenEndpoint=je(d),f=fe(z)});break}case"client_credentials":{I(z=>{z.tokenEndpoint=je(d),f=fe(z)});break}}return f},D=async(f,z)=>{try{const{data:Z}=await v({app_slug:a,auth_details:f,auth_type:t.type,connection_name:l,encrypt_keys:z});o==null||o(Z.id),I(t),T(!1)}catch(Z){console.error("Can't save connection",Z),b({saveConnection:{invalidMessage:"Can't save connection",status:"error"}})}},O=async f=>{try{let z=!1;switch(d.grantType){case"authorization_code":case"authorization_code_pkce":{z=await qe(f,E);break}case"client_credentials":{z=await Oe(f.tokenEndpoint);break}default:throw new Error("Unsupported grant type for OAuth 2 connection")}if(!z)throw new Error("Client id or secret not correct!");await D({...z,...i&&{extraData:i},client_id:d.clientId,client_secret:d.clientSecret,clientAuthentication:d.clientAuthentication,grant_type:d.grantType,refreshTokenUrl:d.refreshTokenUrl||d.tokenUrl},f.encryptKeys)}catch(z){z instanceof Error&&b({clientId:{invalidMessage:z.message,status:"error"}}),console.error(z)}V({}),p(!1)},F=async()=>{const f=K();switch(p(!0),d.grantType){case"authorization_code":case"authorization_code_pkce":{ze(f,p);break}case"client_credentials":{O(f);break}}},U=f=>{if(f.preventDefault(),f.stopPropagation(),b(void 0),!l){b({connectionName:{invalidMessage:"Connection name is required",status:"error"}});return}r&&r(P)===!1||F()};return Fe(()=>{Object.keys(E).length>0&&O(P)},400,[E]),w("form",{onSubmit:U,children:[e,s(te,{"aria-required":!0,disabled:c,invalidMessage:(q=n==null?void 0:n.grant_type)==null?void 0:q.invalidMessage,label:h("Grant Type"),onChange:f=>N("grantType",f),options:[{label:h("Authorization Code"),value:"authorization_code"},{label:h("Authorization Code with PKCE"),value:"authorization_code_pkce"},{label:h("Client Credentials"),value:"client_credentials"}],required:!0,status:(k=n==null?void 0:n.grant_type)==null?void 0:k.status,value:d.grantType,wrapperClassName:"mb-2"}),w(ye,{conditions:d.grantType.startsWith("authorization_code"),children:[s(Ve,{label:h("Callback URL"),value:De.REDIRECT_URI,wrapperClassName:"mb-2"}),s(R,{disabled:c,invalidMessage:(M=n==null?void 0:n.authUrl)==null?void 0:M.invalidMessage,label:h("Authorization URL"),name:"authUrl",onChange:f=>N("authUrl",f.target.value),required:!0,status:(A=n==null?void 0:n.authUrl)==null?void 0:A.status,type:"url",value:d.authUrl,wrapperClassName:"mb-2"})]}),s(R,{disabled:c,invalidMessage:(m=n==null?void 0:n.tokenUrl)==null?void 0:m.invalidMessage,label:h("Access Token URL"),name:"tokenUrl",onChange:f=>N("tokenUrl",f.target.value),required:!0,status:(j=n==null?void 0:n.tokenUrl)==null?void 0:j.status,type:"url",value:d.tokenUrl,wrapperClassName:"mb-2"}),s(R,{disabled:c,helperText:h("if not provided, the token URL will be used to refresh the token"),invalidMessage:(y=n==null?void 0:n.refreshTokenUrl)==null?void 0:y.invalidMessage,label:h("Refresh Token URL"),name:"refreshTokenUrl",onChange:f=>N("refreshTokenUrl",f.target.value),status:(L=n==null?void 0:n.refreshTokenUrl)==null?void 0:L.status,type:"url",value:d.refreshTokenUrl,wrapperClassName:"mb-2"}),s(R,{disabled:c,invalidMessage:(Y=n==null?void 0:n.clientId)==null?void 0:Y.invalidMessage,label:h("Client Id"),name:"clientId",onChange:f=>N("clientId",f.target.value),required:!0,status:(C=n==null?void 0:n.clientId)==null?void 0:C.status,value:d.clientId,wrapperClassName:"mb-2"}),s(R,{disabled:c,invalidMessage:(g=n==null?void 0:n.clientSecret)==null?void 0:g.invalidMessage,label:h("Client Secret"),name:"clientSecret",onChange:f=>N("clientSecret",f.target.value),required:!0,status:(x=n==null?void 0:n.clientSecret)==null?void 0:x.status,value:d.clientSecret,wrapperClassName:"mb-2"}),s(R,{disabled:c,invalidMessage:(S=n==null?void 0:n.scope)==null?void 0:S.invalidMessage,label:h("Scope"),name:"scope",onChange:f=>N("scope",f.target.value),status:(H=n==null?void 0:n.scope)==null?void 0:H.status,value:d.scope,wrapperClassName:"mb-2"}),s(ye,{conditions:d.grantType.startsWith("authorization_code"),children:s(Nt,{addItemButtonLabel:h("Add"),fieldsMetaData:[{componentName:ne.input,name:"key",placeholder:h("Key"),value:""},{componentName:ne.input,name:"value",placeholder:h("Value"),value:""}],label:h("Additional Query Params"),onChange:f=>N("queryParams",f),value:d.queryParams,wrapperClassName:"mb-2"})}),s(te,{disabled:c,invalidMessage:(Q=n==null?void 0:n.clientAuthentication)==null?void 0:Q.invalidMessage,label:h("Client Authentication"),onChange:f=>N("clientAuthentication",f),options:[{label:h("Send as Basic Auth header"),value:"header"},{label:h("Send Client Credentials in body"),value:"body"}],required:!0,status:(W=n==null?void 0:n.clientAuthentication)==null?void 0:W.status,value:d.clientAuthentication,wrapperClassName:"mb-2"}),((se=n==null?void 0:n.saveConnection)==null?void 0:se.status)==="error"&&s(B.Paragraph,{type:"danger",children:(ue=n==null?void 0:n.saveConnection)==null?void 0:ue.invalidMessage}),((pe=n==null?void 0:n.connectionName)==null?void 0:pe.status)==="error"&&s(B.Paragraph,{type:"danger",children:(me=n==null?void 0:n.connectionName)==null?void 0:me.invalidMessage}),w(ae,{gap:8,justify:"end",children:[s($,{onClick:()=>T(!1),children:h("Cancel")}),s($,{disabled:c,htmlType:"submit",loading:c,type:"primary",children:h("Connect")})]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const{Text:xt}=B;function Ut({children:e}){const[t,l]=u.useState(""),[a,i]=u.useState(""),{addConnectionHelpingText:c,appName:o,connectionsTypes:r,customConnection:p,isConnecting:v}=u.useContext(J),E=u.useMemo(()=>r.map(b=>({label:b.label,value:b.type})),[r]),V=b=>{const{value:d}=b.target;l(d)},T=b=>{i(b)},n=b=>{const d=r.find(_=>_.type===b);if(!d)throw new Error("Connection type not found");return d};return u.useEffect(()=>{o&&l(`${o} connection`)},[o]),u.useEffect(()=>{r.length===1&&i(r[0].type)},[]),w(Ie,{children:[s(te,{"aria-readonly":(r==null?void 0:r.length)===1,disabled:v||(r==null?void 0:r.length)===1,label:h("Connection type"),onChange:T,options:E,placeholder:h("Choose type"),value:a,wrapperClassName:"mb-2"}),s(R,{disabled:v,label:h("Connection Name"),name:"connectionName",onChange:V,required:!0,value:t,wrapperClassName:"mb-2"}),c&&s("div",{className:"mb-2",children:s(xt,{type:"secondary",children:s("span",{dangerouslySetInnerHTML:{__html:c}})})}),p&&a==="oauth2"&&s(Dt,{connectionConfig:n("oauth2"),connectionName:t,children:e}),!p&&a==="oauth2"&&s(bt,{connectionConfig:n("oauth2"),connectionName:t,children:e}),a==="bearer_token"&&s(dt,{connectionConfig:n("bearer_token"),connectionName:t,children:e}),a==="api_key"&&s(yt,{connectionConfig:n("api_key"),connectionName:t,customConnection:p,children:e}),a==="basic_auth"&&s(ft,{connectionConfig:n("basic_auth"),connectionName:t,children:e})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function Pt({children:e}){const{isPopoverOpen:t,setIsPopoverOpen:l}=u.useContext(G),a=()=>{l(c=>!c)};return s(ht,{content:s(Ut,{children:e}),destroyTooltipOnHide:!0,open:t,placement:"right",styles:{body:{maxHeight:"100vh",maxWidth:400,overflowY:"auto"}},title:s(Ot,{popoverClose:()=>{l(!1)}}),children:s(oe,{title:h("Add new connection"),children:s($,{onClick:a,children:h("Add Connection")})})})}function Ot({popoverClose:e}){return w(ct,{justify:"space-between",children:[s(B.Title,{level:5,style:{marginBottom:0},children:h("Add New Connection")}),s($,{icon:s(Ue,{}),onClick:e,size:"small",type:"text"})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function Xt({addConnectionHelpingText:e,allowClear:t,appName:l,appSlug:a,children:i,connectionOptionsProp:c,connectionsTypes:o,customConnection:r,extraData:p,helpingText:v,invalidMessage:E,label:V=h("Connection"),loading:T=!1,onConnectionAddChange:n,onConnectionChange:b,onConnectionSaveClick:d,onRender:_,onValidate:P,status:I,value:N,wrapperClassName:K}){const[D,O]=u.useState(!1),[F,U]=u.useState(!1),{id:q}=de(Ne),{states:k}=de(it(q)),M=u.useMemo(()=>{var y;return(y=k==null?void 0:k.connections)==null?void 0:y.map(L=>({label:L.connection_name,value:L.id}))},[k==null?void 0:k.connections]),A=u.useMemo(()=>({isPopoverOpen:F,setIsPopoverOpen:U}),[F]),m=u.useMemo(()=>({addConnectionHelpingText:e,appName:l,appSlug:a,connectionsTypes:o,customConnection:r,extraData:p,isConnecting:D,onConnectionAddChange:n,onConnectionChange:b,onConnectionSaveClick:d,onValidate:P,setIsConnecting:O}),[e,l,a,o,r,p,D,n,b,d,P]),j=y=>{b==null||b(y)};return u.useEffect(()=>{_==null||_()},[]),s(te,{allowClear:t,disabled:T||F,helperText:v,invalidMessage:E,label:V,loading:T,onChange:j,optionFilterProp:"label",options:c||M,placeholder:h("Choose a connection"),showSearch:!0,status:I,suffix:s(J.Provider,{value:m,children:s(G.Provider,{value:A,children:s(Pt,{children:i})})}),value:N,wrapperClassName:`w-100 ${K}`})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};export{$e as B,Xt as C,Ve as I,Nt as R,vt as T};

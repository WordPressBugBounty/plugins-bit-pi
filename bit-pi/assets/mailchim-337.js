import{h as y}from"./machine.-202.js";import{dx as m,aH as _,_ as u}from"./main-salty-geckos-sort.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const k=e=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"POST",url:"https://login.mailchimp.com/oauth2/metadata"}),T=(e,t)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",url:`https://${t}.api.mailchimp.com/3.0/lists?count=1000&offset=0`}),A=(e,t,i)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",url:`https://${t}.api.mailchimp.com/3.0/lists/${i}/segments?count=1000&offset=0`}),w=e=>_("mailchimp/get-audience-fields",e),E=(e,t,i,o,n,r)=>m({bodyParams:{events:n,sources:r,url:o},headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:i}],"Content-Type":"application/json"},method:"POST",url:`https://${t}.api.mailchimp.com/3.0/lists/${e}/webhooks`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const M=async e=>{var r;e.setComponent("select-audience",a=>{a.loading=!0});const t=await e.getConnection();if(!t){e.setComponent("select-audience",a=>{a.loading=!1});return}const i=await k(t.auth_details.access_token);if(i.status=="error"||!((r=i.data)!=null&&r.dc)){e.setComponent("select-audience",a=>{a.loading=!1});return}e.setDb(a=>{a.dataCenter=i.data.dc});const{data:o,status:n}=await T(t.auth_details.access_token,i.data.dc);if(n=="error"){e.setComponent("select-audience",a=>{e.util.isSelectComponent(a)&&(a.status=n,a.invalidMessage=o)});return}e.setComponent("select-audience",a=>{var c;e.util.isSelectComponent(a)&&(a.options=(c=o==null?void 0:o.lists)==null?void 0:c.map(s=>({label:s.name,value:s.id})),a.loading=!1)})},O=async e=>{var r,a,c;e.setComponent("select-tag",s=>{s.loading=!0});const t=await e.getConnection();if(!t||!((r=e.db)!=null&&r.dataCenter)){e.setComponent("select-tag",s=>{s.loading=!1});return}const i=(a=e.getComponent("select-audience"))==null?void 0:a.value,{data:o,status:n}=await A(t.auth_details.access_token,(c=e.db)==null?void 0:c.dataCenter,i);if(n=="error"){e.setComponent("select-tag",s=>{e.util.isSelectComponent(s)&&(s.status=n,s.invalidMessage=o)});return}e.setComponent("select-tag",s=>{var l;e.util.isSelectComponent(s)&&(s.options=(l=o==null?void 0:o.segments)==null?void 0:l.map(d=>({label:d.name,value:d.name})),s.loading=!1)})},j=async e=>{var r,a,c,s;const t=await e.getConnection(),i=(r=e.getComponent("select-module"))==null?void 0:r.value,o=(a=e.getComponent("select-audience"))==null?void 0:a.value,{data:n}=await w({accessToken:t&&((c=t.auth_details)==null?void 0:c.access_token),dataCenter:(s=e.db)==null?void 0:s.dataCenter,listId:o,module:i});e.setComponent("field-map",l=>{if(!e.util.isRepeaterFieldComponent(l))return;const d=l.fieldsMetaData[0];d.options=n==null?void 0:n.audienceField,l.loading=!1}),y({$:e,componentId:"field-map",dbKey:"fieldMap",fields:n==null?void 0:n.audienceField,mapFieldKey:"mailchimpField",mapFieldValue:"value"})},P=async(e,t)=>{var l,d,p,C,f,g,b;const i=await e.getConnection();if(!i||!((l=i.auth_details)!=null&&l.access_token))return;const o=(d=e.db)==null?void 0:d.webhookEvents,n=(p=e.db)==null?void 0:p.webhookSources,r=o&&Array.isArray(o)?Object.fromEntries(o.map(h=>[h,!0])):{},a=n&&Array.isArray(n)?Object.fromEntries(n.map(h=>[h,!0])):{},{data:c}=await E((C=e.db)==null?void 0:C.audienceList,(f=e.db)==null?void 0:f.dataCenter,i.auth_details.access_token,t,r,a);let s="We have attached the webhook to your MailChimp.";(!c||"errors"in c||"detail"in c)&&(s=((b=(g=c==null?void 0:c.errors)==null?void 0:g[0])==null?void 0:b.message)||(c==null?void 0:c.detail)||"Unknown error."),e.setComponent("note-id",h=>{e.util.isNoteComponent(h)&&(h.note=[s],h.render=!0)})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const N=e=>({addConnectionHelpingText:u("You can find credentials from ")+`<a target="_blank" class="text-blue-600 underline" rel="noopener noreferrer nofollow" href="https://us7.admin.mailchimp.com/account/oauth2/">${u("Here")}</a>`,componentName:e.componentName.connection,connectionsTypes:[{authCodeEndpoint:{method:"GET",queryParams:{client_id:"",response_type:"code"},url:"https://login.mailchimp.com/oauth2/authorize"},encryptKeys:["access_token","refresh_token","client_secret"],label:u("OAuth 2"),refreshTokenUrl:"",tokenEndpoint:{bodyParams:{client_id:"",client_secret:"",grant_type:"authorization_code"},method:"POST",url:"https://login.mailchimp.com/oauth2/token"},type:"oauth2"}],fieldType:"config",id:"connection-id",label:u("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0}),F=({$:e,e:t})=>{e.setThisComponent(i=>{var o;if(e.util.isConnectionComponent(i))for(const n of i.connectionsTypes)n.type==="oauth2"&&((o=n.authCodeEndpoint)!=null&&o.queryParams&&(n.authCodeEndpoint.queryParams.client_id=t.clientId),n.tokenEndpoint.bodyParams&&(n.tokenEndpoint.bodyParams.client_id=t.clientId,n.tokenEndpoint.bodyParams.client_secret=t.clientSecret))})},I=e=>({$:t,e:i})=>{t.setThisComponent(o=>{o.value=i}),t.setDb(o=>{o[e]=i})};export{F as a,j as b,N as c,P as d,O as e,M as f,I as h};

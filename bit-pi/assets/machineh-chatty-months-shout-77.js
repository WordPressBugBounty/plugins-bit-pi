import{_ as d,db as m}from"./main-chatty-months-shout.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const S=e=>({addConnectionHelpingText:d("You can find credentials from ")+`<a target="_blank" class="text-blue-600 underline" rel="noopener noreferrer nofollow" href="https://console.cloud.google.com/apis/credentials">${d("Here")}</a>`,allowClear:!0,componentName:e.componentName.connection,connectionsTypes:[{authCodeEndpoint:{method:"GET",queryParams:{access_type:"offline",client_id:"",prompt:"consent",response_type:"code",scope:"https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly"},url:"https://accounts.google.com/o/oauth2/v2/auth"},encryptKeys:["access_token","refresh_token","client_secret"],label:d("OAuth 2"),refreshTokenUrl:"https://oauth2.googleapis.com/token",tokenEndpoint:{bodyParams:{client_id:"",client_secret:"",grant_type:"authorization_code"},method:"POST",url:"https://oauth2.googleapis.com/token"},type:"oauth2",verifyConnection:{method:"GET",queryParams:{access_token:"$_access_token_$"},responseMatch:{scope:"https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly"},url:"https://www.googleapis.com/oauth2/v2/tokeninfo"}}],fieldType:"config",id:"connection-id",label:d("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0}),T=({$:e,e:t})=>{e.setThisComponent(o=>{var s;if(e.util.isConnectionComponent(o))for(const n of o.connectionsTypes)n.type==="oauth2"&&((s=n.authCodeEndpoint)!=null&&s.queryParams&&(n.authCodeEndpoint.queryParams.client_id=t.clientId),n.tokenEndpoint.bodyParams&&(n.tokenEndpoint.bodyParams.client_id=t.clientId,n.tokenEndpoint.bodyParams.client_secret=t.clientSecret))})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const f=async e=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{q:"mimeType='application/vnd.google-apps.spreadsheet'"},url:"https://www.googleapis.com/drive/v3/files"}),C=async(e,t)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{fields:"sheets.properties.title,sheets.properties.gridProperties.columnCount"},url:`https://sheets.googleapis.com/v4/spreadsheets/${t}`}),_=async(e,t,o)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",queryParams:{dateTimeRenderOption:"FORMATTED_STRING",valueRenderOption:"FORMATTED_VALUE"},url:`https://sheets.googleapis.com/v4/spreadsheets/${t}/values/${encodeURIComponent(o)}!1:1`});globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const A=(e,t)=>{const o=e.getComponent("spreadsheet-id");!t.isSelectComponent(o)||!o.value||!o.options||o.options.some(s=>s.value===o.value)||(e.setComponent("spreadsheet-id",s=>{s.value=void 0}),e.setComponent("sheet-title",s=>{s.value=void 0}),e.setDb(s=>{s.spreadsheetId=void 0,s.sheetTitle=void 0}))},E=async e=>{e.setComponent("spreadsheet-id",n=>{n.loading=!0});const t=await e.getConnection("expires_in");if(!t){e.setComponent("spreadsheet-id",n=>{n.loading=!1});return}const{data:o,status:s}=await f(t.auth_details.access_token);if(s==="error"){e.setComponent("spreadsheet-id",n=>{e.util.isSelectComponent(n)&&(n.status=s,n.invalidMessage=o)}),console.error("Failed to fetch spreadsheets");return}e.setComponent("spreadsheet-id",n=>{var a;e.util.isSelectComponent(n)&&(n.options=(a=o==null?void 0:o.files)==null?void 0:a.map(i=>({label:i.name,value:i.id})),n.loading=!1,n.status=void 0)})},k=async e=>{var n;e.setComponent("sheet-title",a=>{a.loading=!0});const t=await e.getConnection("expires_in");if(!t){e.setComponent("sheet-title",a=>{a.loading=!1});return}const{data:o,status:s}=await C(t.auth_details.access_token,(n=e.getComponent("spreadsheet-id"))==null?void 0:n.value);if(s==="error"){e.setComponent("sheet-title",a=>{e.util.isSelectComponent(a)&&(a.status=s,a.invalidMessage=o)}),console.error("Failed to fetch sheets");return}e.setComponent("sheet-title",a=>{var i;e.util.isSelectComponent(a)&&(a.options=(i=o==null?void 0:o.sheets)==null?void 0:i.map(l=>({label:l.properties.title,value:l.properties.title})),a.loading=!1)})},g=e=>{let t=e+1,o="";for(;t>0;)t--,o=`${String.fromCharCode(t%26+65)}${o}`,t=Math.floor(t/26);return o},w=async e=>{var n,a,i;const t=await e.getConnection("expires_in");if(!t)return 0;const{data:o}=await C(t.auth_details.access_token,(n=e.getComponent("spreadsheet-id"))==null?void 0:n.value);return((i=(a=o==null?void 0:o.sheets)==null?void 0:a.find(l=>{var h;return l.properties.title===((h=e.getComponent("sheet-title"))==null?void 0:h.value)}))==null?void 0:i.properties.gridProperties.columnCount)||0},v=async e=>{var s,n,a,i,l,h;let t=[];const o=await e.getConnection("expires_in");if(!o)return t;if((s=e.getComponent("contains-header-row"))!=null&&s.value&&((n=e.getComponent("contains-header-row"))==null?void 0:n.value)==="yes"){const{data:c,status:p}=await _(o.auth_details.access_token,(a=e.getComponent("spreadsheet-id"))==null?void 0:a.value,(i=e.getComponent("sheet-title"))==null?void 0:i.value);if(p==="error"||c!=null&&c.error){e.setComponent("column-to-match-on",r=>{var u;e.util.isSelectComponent(r)&&(r.status="error",r.loading=!1,r.invalidMessage=(u=c.error)==null?void 0:u.message)}),console.error("Failed to fetch header rows");return}t=(h=(l=c==null?void 0:c.values)==null?void 0:l[0])==null?void 0:h.map((r,u)=>({label:r===""?g(u):r,value:`${u}:${r}`})).filter(r=>r.value)}else{const c=await w(e);for(let p=0;p<c;p++){const r=g(p);t.push({label:r,value:`${p}:${r}`})}}return t},P=async e=>{if(e.setComponent("column-to-match-on",s=>{s.loading=!0}),!await e.getConnection("expires_in")){e.setComponent("column-to-match-on",s=>{s.loading=!1});return}const o=await v(e);if(!o){e.setComponent("column-to-match-on",s=>{e.util.isSelectComponent(s)&&(s.loading=!1,s.options=[],s.value=void 0)});return}e.setComponent("column-to-match-on",s=>{e.util.isSelectComponent(s)&&(s.options=o,s.loading=!1)})},y=(e=26)=>{const t=[];for(let o=0;o<e;o+=1){let s=o,n="";o>25&&(n=String.fromCharCode(65+o%26),s=Math.floor(o/26)-1);const a=String.fromCharCode(65+s);t.push({label:a+n,value:a+n})}return t},R=async e=>{var s;e.setComponent("row-data",n=>{n.loading=!0,e.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!0)});const t=await e.getConnection("expires_in");if(!t){e.setComponent("row-data",n=>{n.loading=!1,e.util.isRepeaterFieldComponent(n)&&(n.labelActionLoading=!1)});return}const{data:o}=await C(t.auth_details.access_token,(s=e.getComponent("spreadsheet-id"))==null?void 0:s.value);e.setComponent("row-data",n=>{var l,h;if(!e.util.isRepeaterFieldComponent(n))return;const a=n.fieldsMetaData[0],i=(h=(l=o==null?void 0:o.sheets)==null?void 0:l.find(c=>{var p;return c.properties.title===((p=e.getComponent("sheet-title"))==null?void 0:p.value)}))==null?void 0:h.properties.gridProperties.columnCount;a.options=y(i),n.loading=!1,n.labelActionLoading=!1})};export{A as a,k as b,S as c,P as d,E as f,T as h,R as s};

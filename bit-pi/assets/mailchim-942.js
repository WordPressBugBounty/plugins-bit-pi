import{h as f}from"./machine.-560.js";import{dx as m,aH as C,_ as h}from"./main-rotten-forks-end.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const g=e=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"POST",url:"https://login.mailchimp.com/oauth2/metadata"}),b=(e,t)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",url:`https://${t}.api.mailchimp.com/3.0/lists?count=1000&offset=0`}),_=(e,t,i)=>m({headers:{Authorization:["Bearer ",{encryption:"hmac_decrypt",value:e}]},method:"GET",url:`https://${t}.api.mailchimp.com/3.0/lists/${i}/segments?count=1000&offset=0`}),y=e=>C("mailchimp/get-audience-fields",e),k=e=>C("mailchimp/set-mailchimp-webhook",e);globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const A=async e=>{var s;e.setComponent("select-audience",o=>{o.loading=!0});const t=await e.getConnection();if(!t){e.setComponent("select-audience",o=>{o.loading=!1});return}const i=await g(t.auth_details.access_token);if(i.status=="error"||!((s=i.data)!=null&&s.dc)){e.setComponent("select-audience",o=>{o.loading=!1});return}e.setDb(o=>{o.dataCenter=i.data.dc});const{data:n,status:a}=await b(t.auth_details.access_token,i.data.dc);if(a=="error"){e.setComponent("select-audience",o=>{e.util.isSelectComponent(o)&&(o.status=a,o.invalidMessage=n)});return}e.setComponent("select-audience",o=>{var l;e.util.isSelectComponent(o)&&(o.options=(l=n==null?void 0:n.lists)==null?void 0:l.map(c=>({label:c.name,value:c.id})),o.loading=!1)})},E=async e=>{var s,o,l;e.setComponent("select-tag",c=>{c.loading=!0});const t=await e.getConnection();if(!t||!((s=e.db)!=null&&s.dataCenter)){e.setComponent("select-tag",c=>{c.loading=!1});return}const i=(o=e.getComponent("select-audience"))==null?void 0:o.value,{data:n,status:a}=await _(t.auth_details.access_token,(l=e.db)==null?void 0:l.dataCenter,i);if(a=="error"){e.setComponent("select-tag",c=>{e.util.isSelectComponent(c)&&(c.status=a,c.invalidMessage=n)});return}e.setComponent("select-tag",c=>{var r;e.util.isSelectComponent(c)&&(c.options=(r=n==null?void 0:n.segments)==null?void 0:r.map(d=>({label:d.name,value:d.name})),c.loading=!1)})},v=async e=>{var s,o,l,c;const t=await e.getConnection(),i=(s=e.getComponent("select-module"))==null?void 0:s.value,n=(o=e.getComponent("select-audience"))==null?void 0:o.value,{data:a}=await y({accessToken:t&&((l=t.auth_details)==null?void 0:l.access_token),dataCenter:(c=e.db)==null?void 0:c.dataCenter,listId:n,module:i});e.setComponent("field-map",r=>{if(!e.util.isRepeaterFieldComponent(r))return;const d=r.fieldsMetaData[0];d.options=a==null?void 0:a.audienceField,r.loading=!1}),f({$:e,componentId:"field-map",dbKey:"fieldMap",fields:a==null?void 0:a.audienceField,mapFieldKey:"mailchimpField",mapFieldValue:"value"})},M=async(e,t)=>{var s,o,l,c,r,d,p;const i=await e.getConnection();if(!i||!((s=i.auth_details)!=null&&s.access_token))return;const{data:n}=await k({audienceList:(o=e.db)==null?void 0:o.audienceList,dataCenter:(l=e.db)==null?void 0:l.dataCenter,token:i.auth_details.access_token,webhookEvent:(c=e.db)==null?void 0:c.webhookEvent,webhookSource:(r=e.db)==null?void 0:r.webhookSource,webhookUrl:t});let a="We have attached the webhook to your MailChimp.";(!n||"errors"in n||"detail"in n)&&(a=((p=(d=n==null?void 0:n.errors)==null?void 0:d[0])==null?void 0:p.message)||(n==null?void 0:n.detail)||"Unknown error."),e.setComponent("note-id",u=>{e.util.isNoteComponent(u)&&(u.note=[a],u.render=!0)})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const S=e=>({addConnectionHelpingText:h("You can find credentials from ")+`<a target="_blank" class="text-blue-600 underline" rel="noopener noreferrer nofollow" href="https://us7.admin.mailchimp.com/account/oauth2/">${h("Here")}</a>`,componentName:e.componentName.connection,connectionsTypes:[{authCodeEndpoint:{method:"GET",queryParams:{client_id:"",response_type:"code"},url:"https://login.mailchimp.com/oauth2/authorize"},encryptKeys:["access_token","refresh_token","client_secret"],label:h("OAuth 2"),refreshTokenUrl:"",tokenEndpoint:{bodyParams:{client_id:"",client_secret:"",grant_type:"authorization_code"},method:"POST",url:"https://login.mailchimp.com/oauth2/token"},type:"oauth2"}],fieldType:"config",id:"connection-id",label:h("Select Connection"),onConnectionAddChange:"CONNECTION_ADD_CHANGE",onConnectionChange:"SET_CONNECTION",render:!0,value:void 0}),N=({$:e,e:t})=>{e.setThisComponent(i=>{var n;if(e.util.isConnectionComponent(i))for(const a of i.connectionsTypes)a.type==="oauth2"&&((n=a.authCodeEndpoint)!=null&&n.queryParams&&(a.authCodeEndpoint.queryParams.client_id=t.clientId),a.tokenEndpoint.bodyParams&&(a.tokenEndpoint.bodyParams.client_id=t.clientId,a.tokenEndpoint.bodyParams.client_secret=t.clientSecret))})},F=e=>({$:t,e:i})=>{t.setThisComponent(n=>{n.value=i}),t.setDb(n=>{n[e]=i})};export{N as a,v as b,S as c,E as d,M as e,A as f,F as h};
